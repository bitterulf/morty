<html>
    <head>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="/primus/primus.js"></script>
        <style>
            body {
                background-color: grey;
            }

            .map {
                position: relative;
                width: 300;
                height: 300;
                border: 1px solid black;
            }

            .user {
                position: absolute;
                width: 50px;
                height: 50px;
                border: 1px solid blue;
            }

            .portal {
                position: absolute;
                width: 50px;
                height: 50px;
                border: 1px solid yellow;
            }

            .unit {
                position: absolute;
                width: 50px;
                height: 50px;
                border: 3px dashed green;
            }
        </style>
        <script>
            let identity;
            let state;
            let map;

            const primus = Primus.connect();

            var Hello = {
                view: function() {
                    if (!state || !map) {
                        return m('div', 'loading');
                    }

                    const tiles = [];

                    const tileset = map.tilesets[0];
                    tileset.height = tileset.imageheight / tileset.tileheight;
                    tileset.width =tileset.imagewidth / tileset.tilewidth;

                    const tileDefinition = [];

                    for (let y = 0; y < tileset.height; y++) {
                        for (let x = 0; x < tileset.width; x++) {
                            const tileId = tileset.firstgid + (y * tileset.width) + x;
                            tileDefinition[tileId] = {
                                x: x,
                                y: y,
                                image: tileset.image
                            };
                        }
                    }

                    for (let y = 0; y < map.height; y++) {
                        for (let x = 0; x < map.width; x++) {
                            const index = y * map.width + x;
                            const tileDefId = map.layers[0].data[index];

                            tiles.push({x: x, y: y, definition: tileDefinition[tileDefId]});
                        }
                    }

                    console.log(tiles);

                    return m('main', [
                        m('h1', {}, identity),
                        m('button',  { onclick: function() {
                            primus.write({type: 'zapp', payload: {}});
                        } }, 'portal gun'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'left', payload: {}});
                        } }, 'left'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'right', payload: {}});
                        } }, 'right'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'up', payload: {}});
                        } }, 'up'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'down', payload: {}});
                        } }, 'down'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'steal', payload: {}});
                        } }, 'steal'),
                        m('div', {className: 'map'}, [
                            m('div', {}, tiles.map(function(tile) {
                                return m('div', {style: 'background-repeat: no-repeat; background-image: url("'+tile.definition.image+'"); background-position: ' + (tile.definition.x * 32 * -1) + 'px ' + (tile.definition.y * 32 * -1) + 'px; width: 32px; height: 32px; position: absolute; left: '+tile.x*32+'px; top: '+tile.y*32+'px;' });
                            })),
                            m('div', {}, state.users.map(function(user) {
                                return m('div', {className: 'user', style: 'left: '+user.x*50+'px; top: '+user.y*50+'px;' }, user.id + (user.money ? ' money: ' + user.money : '') );
                            })),
                            m('div', {}, state.portals.map(function(portal) {
                                return m('div', {className: 'portal', style: 'left: '+portal.x*50+'px; top: '+portal.y*50+'px;' }, 'portal '+portal.timer+' from '+portal.owner);
                            })),
                            m('div', {}, state.units.map(function(unit) {
                                return m('div', {className: 'unit', style: 'left: '+unit.x*50+'px; top: '+unit.y*50+'px;' }, 'unit '+unit.id+' '+unit.owner);
                            })),
                            m('div', {}, tiles.map(function(tile) {
                                return m('div', {style: 'border: dashed black 1px; width: 32px; height: 32px; position: absolute; left: '+tile.x*32+'px; top: '+tile.y*32+'px;' });
                            })),
                        ])
                    ])
                }
            }

            primus.on('data', function message(data) {
                state = data.state;
                identity = data.identity;
                m.redraw();
                console.log('Received a new message from the server', data);
            });

            m.request({
                method: 'GET',
                url: '/map.json'
            })
            .then(function(result) {
                map = result;
            });
        </script>
        <title>morty</title>
    </head>
    <body>
        <div id='app'></div>
        <script>
            m.mount(document.querySelector('#app'), Hello)
        </script>
    </body>
</html>
