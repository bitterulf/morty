<html>
    <head>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="/primus/primus.js"></script>
        <style>
            body {
                background-color: grey;
            }

            .map {
                position: relative;
                width: 300;
                height: 300;
                border: 1px solid black;
            }

            .user {
                position: absolute;
                width: 50px;
                height: 50px;
                border: 1px solid blue;
            }

            .portal {
                position: absolute;
                width: 50px;
                height: 50px;
                border: 1px solid yellow;
            }
        </style>
        <script>
            let state;

            const primus = Primus.connect();

            var Hello = {
                view: function() {
                    if (!state) {
                        return m('div', 'loading');
                    }

                    return m('main', [
                        m('h1', {}, 'morty'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'zapp', payload: {}});
                        } }, 'portal gun'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'left', payload: {}});
                        } }, 'left'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'right', payload: {}});
                        } }, 'right'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'up', payload: {}});
                        } }, 'up'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'down', payload: {}});
                        } }, 'down'),
                        m('button',  { onclick: function() {
                            primus.write({type: 'steal', payload: {}});
                        } }, 'steal'),
                        m('div', {className: 'map'}, [
                            m('div', {}, state.users.map(function(user) {
                                return m('div', {className: 'user', style: 'left: '+user.x*50+'px; top: '+user.y*50+'px;' }, user.id + (user.money ? ' money: ' + user.money : '') );
                            })),
                            m('div', {}, state.portals.map(function(portal) {
                                return m('div', {className: 'portal', style: 'left: '+portal.x*50+'px; top: '+portal.y*50+'px;' }, 'portal from '+portal.owner);
                            }))
                        ])
                    ])
                }
            }

            primus.on('data', function message(data) {
                state = data;
                m.redraw();
                console.log('Received a new message from the server', data);
            });
        </script>
        <title>morty</title>
    </head>
    <body>
        <div id='app'></div>
        <script>
            m.mount(document.querySelector('#app'), Hello)
        </script>
    </body>
</html>
